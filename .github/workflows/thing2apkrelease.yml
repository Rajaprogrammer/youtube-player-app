name: Build and Release APK

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Release APK
        run: flutter build apk --release

      - name: Find APK
        id: find_apk
        run: |
          echo "ðŸ” Searching for APK files..."
          
          # Search all directories for APK
          APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ No APK found!"
            echo "ðŸ“ Listing build directory:"
            find . -type d -name "outputs" -exec ls -la {} \; 2>/dev/null
            exit 1
          fi
          
          echo "âœ… Found APK: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Generate Timestamp and SHA-256
        id: generate_info
        run: |
          # Generate timestamp
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          READABLE_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          # Get APK path
          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          
          # Generate SHA-256
          SHA256=$(sha256sum "$APK_PATH" | awk '{print $1}')
          
          # Rename APK with timestamp
          NEW_APK_NAME="app-release-$TIMESTAMP.apk"
          cp "$APK_PATH" "$NEW_APK_NAME"
          
          # Create checksum file
          echo "$SHA256  $NEW_APK_NAME" > SHA256SUMS.txt
          
          # Export outputs
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "readable_time=$READABLE_TIME" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "new_apk_name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… APK: $NEW_APK_NAME"
          echo "âœ… SHA-256: $SHA256"
          echo "âœ… Time: $READABLE_TIME"

      - name: Create Release Notes
        run: |
          cat << EOF > RELEASE_NOTES.md
          # ðŸ“± APK Release Build
          
          ## ðŸ“‹ Build Information
          - **Build Time:** ${{ steps.generate_info.outputs.readable_time }}
          - **Commit:** \`${{ github.sha }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Workflow Run:** #${{ github.run_number }}
          
          ## ðŸ” SHA-256 Checksum
          \`\`\`
          ${{ steps.generate_info.outputs.sha256 }}
          \`\`\`
          
          ## âœ… Verify Download
          
          **Linux/Mac:**
          \`\`\`bash
          sha256sum ${{ steps.generate_info.outputs.new_apk_name }}
          \`\`\`
          
          **Windows PowerShell:**
          \`\`\`powershell
          Get-FileHash ${{ steps.generate_info.outputs.new_apk_name }} -Algorithm SHA256
          \`\`\`
          
          ## ðŸ“¥ Install
          1. Download the APK
          2. Verify checksum matches above
          3. Enable "Unknown Sources" in Android settings
          4. Install APK
          
          ---
          *ðŸ¤– Auto-generated by GitHub Actions*
          EOF

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ steps.generate_info.outputs.timestamp }}
          path: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          retention-days: 90

      - name: Create GitHub Release
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}-${{ steps.generate_info.outputs.timestamp }}
          name: Release v1.0.${{ github.run_number }} - ${{ steps.generate_info.outputs.readable_time }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **APK** | \`${{ steps.generate_info.outputs.new_apk_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time** | ${{ steps.generate_info.outputs.readable_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA-256** | \`${{ steps.generate_info.outputs.sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
