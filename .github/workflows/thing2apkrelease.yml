name: Build and Release APK

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Sign APK
        id: sign_apk
        run: |
          # Create keystore directory
          mkdir -p $HOME/.android
          
          # Generate keystore if not exists (for demo purposes)
          keytool -genkeypair \
            -keystore $HOME/.android/release.keystore \
            -alias release-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=GitHub Actions, OU=CI/CD, O=MyOrg, L=City, S=State, C=US"
          
          # Sign the APK
          $ANDROID_HOME/build-tools/*/apksigner sign \
            --ks $HOME/.android/release.keystore \
            --ks-key-alias release-key \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out app/build/outputs/apk/release/app-release-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk || \
          cp app/build/outputs/apk/release/app-release-unsigned.apk \
             app/build/outputs/apk/release/app-release-signed.apk

      - name: Generate Timestamp and SHA-256
        id: generate_info
        run: |
          # Generate timestamp
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          READABLE_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "readable_time=$READABLE_TIME" >> $GITHUB_OUTPUT
          
          # Find APK file
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          
          # Generate SHA-256
          SHA256=$(sha256sum "$APK_PATH" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          # Create checksum file
          echo "$SHA256  $(basename $APK_PATH)" > SHA256SUMS.txt
          
          # Rename APK with timestamp
          NEW_APK_NAME="app-release-$TIMESTAMP.apk"
          cp "$APK_PATH" "$NEW_APK_NAME"
          echo "new_apk_name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          
          echo "‚úÖ APK: $NEW_APK_NAME"
          echo "‚úÖ SHA-256: $SHA256"
          echo "‚úÖ Time: $READABLE_TIME"

      - name: Create Release Notes
        id: release_notes
        run: |
          cat << EOF > RELEASE_NOTES.md
          # üì± APK Release Build
          
          ## üìã Build Information
          - **Build Time:** ${{ steps.generate_info.outputs.readable_time }}
          - **Commit:** \`${{ github.sha }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Workflow:** \`${{ github.workflow }}\`
          
          ## üîê Security Information
          ### SHA-256 Checksum
          \`\`\`
          ${{ steps.generate_info.outputs.sha256 }}
          \`\`\`
          
          ### Verification
          To verify the APK integrity, run:
          \`\`\`bash
          sha256sum ${{ steps.generate_info.outputs.new_apk_name }}
          \`\`\`
          
          Expected output:
          \`\`\`
          ${{ steps.generate_info.outputs.sha256 }}  ${{ steps.generate_info.outputs.new_apk_name }}
          \`\`\`
          
          ## üì¶ Files Included
          - APK file with timestamp
          - SHA256SUMS.txt verification file
          
          ## ‚öôÔ∏è Build Details
          - **Runner OS:** Ubuntu Latest
          - **Java Version:** 17 (Temurin)
          - **Gradle Version:** Wrapper
          
          ---
          *Automatically generated by GitHub Actions*
          EOF

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ steps.generate_info.outputs.timestamp }}
          path: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          retention-days: 90

      - name: Create GitHub Release
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}-${{ steps.generate_info.outputs.timestamp }}
          name: Release v1.0.${{ github.run_number }} - ${{ steps.generate_info.outputs.readable_time }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const sha256 = '${{ steps.generate_info.outputs.sha256 }}';
            const timestamp = '${{ steps.generate_info.outputs.readable_time }}';
            const apkName = '${{ steps.generate_info.outputs.new_apk_name }}';
            
            const comment = `## üöÄ APK Build Successful
            
            **Build Time:** ${timestamp}
            **APK File:** \`${apkName}\`
            
            ### SHA-256 Checksum
            \`\`\`
            ${sha256}
            \`\`\`
            
            üì• Download the APK from the artifacts section above.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
