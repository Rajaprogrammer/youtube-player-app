name: Build and Release APK

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.2

      - name: Check for gradlew
        id: check_gradlew
        run: |
          if [ -f "gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            chmod +x gradlew
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ gradlew not found, will use gradle command"
          fi

      - name: Build Release APK
        run: |
          if [ "${{ steps.check_gradlew.outputs.exists }}" == "true" ]; then
            ./gradlew assembleRelease
          else
            gradle assembleRelease
          fi

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find . -name "*.apk" -path "*/release/*" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ No APK found!"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Found APK: $APK_PATH"

      - name: Sign APK (if unsigned)
        id: sign_apk
        run: |
          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          
          # Check if APK is already signed
          if $ANDROID_HOME/build-tools/*/apksigner verify "$APK_PATH" 2>/dev/null; then
            echo "âœ… APK is already signed"
            echo "signed_apk=$APK_PATH" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ APK is unsigned, signing now..."
            
            # Create keystore
            mkdir -p $HOME/.android
            keytool -genkeypair \
              -keystore $HOME/.android/release.keystore \
              -alias release-key \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=GitHub Actions, OU=CI/CD, O=MyOrg, L=City, S=State, C=US"
            
            # Sign APK
            SIGNED_APK="${APK_PATH%.apk}-signed.apk"
            $ANDROID_HOME/build-tools/*/apksigner sign \
              --ks $HOME/.android/release.keystore \
              --ks-key-alias release-key \
              --ks-pass pass:android \
              --key-pass pass:android \
              --out "$SIGNED_APK" \
              "$APK_PATH"
            
            echo "signed_apk=$SIGNED_APK" >> $GITHUB_OUTPUT
          fi

      - name: Generate Timestamp and SHA-256
        id: generate_info
        run: |
          # Generate timestamp
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          READABLE_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "readable_time=$READABLE_TIME" >> $GITHUB_OUTPUT
          
          # Get signed APK path
          APK_PATH="${{ steps.sign_apk.outputs.signed_apk }}"
          
          # Generate SHA-256
          SHA256=$(sha256sum "$APK_PATH" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          # Create checksum file
          echo "$SHA256  $(basename $APK_PATH)" > SHA256SUMS.txt
          
          # Rename APK with timestamp
          NEW_APK_NAME="app-release-$TIMESTAMP.apk"
          cp "$APK_PATH" "$NEW_APK_NAME"
          echo "new_apk_name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… APK: $NEW_APK_NAME"
          echo "âœ… SHA-256: $SHA256"
          echo "âœ… Time: $READABLE_TIME"

      - name: Create Release Notes
        run: |
          cat << EOF > RELEASE_NOTES.md
          # ðŸ“± APK Release Build
          
          ## ðŸ“‹ Build Information
          - **Build Time:** ${{ steps.generate_info.outputs.readable_time }}
          - **Commit:** \`${{ github.sha }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Workflow Run:** #${{ github.run_number }}
          
          ## ðŸ” Security Information
          ### SHA-256 Checksum
          \`\`\`
          ${{ steps.generate_info.outputs.sha256 }}
          \`\`\`
          
          ### Verification Commands
          
          **Linux/Mac:**
          \`\`\`bash
          sha256sum ${{ steps.generate_info.outputs.new_apk_name }}
          \`\`\`
          
          **Windows (PowerShell):**
          \`\`\`powershell
          Get-FileHash ${{ steps.generate_info.outputs.new_apk_name }} -Algorithm SHA256
          \`\`\`
          
          **Expected Output:**
          \`\`\`
          ${{ steps.generate_info.outputs.sha256 }}
          \`\`\`
          
          ## ðŸ“¦ Download & Install
          1. Download the APK file below
          2. Verify SHA-256 checksum matches
          3. Enable "Install from Unknown Sources" in Android settings
          4. Install the APK
          
          ## âš™ï¸ Build Environment
          - **OS:** Ubuntu Latest
          - **Java:** 17 (Temurin)
          - **Build Tool:** Gradle
          
          ---
          *ðŸ¤– Automated build via GitHub Actions*
          EOF

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ steps.generate_info.outputs.timestamp }}
          path: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          retention-days: 90

      - name: Create GitHub Release
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}-${{ steps.generate_info.outputs.timestamp }}
          name: Release v1.0.${{ github.run_number }} - ${{ steps.generate_info.outputs.readable_time }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.generate_info.outputs.new_apk_name }}
            SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display Summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Information" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** \`${{ steps.generate_info.outputs.new_apk_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** ${{ steps.generate_info.outputs.readable_time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA-256:** \`${{ steps.generate_info.outputs.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Check the release or artifacts section to download the APK." >> $GITHUB_STEP_SUMMARY
